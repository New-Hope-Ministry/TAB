const updateInterval=100;let interval,progressBar,utter,voices,estimatedDuration=0,i=0,isPaused=!1,playerOpen=!1,playPause=!0,progress=0,synth=null,textSpeech="";function listVoices(){let e;voices=speechSynthesis.getVoices(),voices&&voices.forEach(((t,n)=>{t&&(e={idx:n,name:t.name,lang:t.lang,default:t.default},localVoices.push(e),n++)}))}function checkVoices(){let e=document.getElementById("id-languages");localVoices.forEach((t=>{if(t.lang)for(let n=1;n<e.children.length-1;n++)if(e.children[n].dataset.lngc===t.lang){e.children[n].dataset.keep=1;break}}));for(let t=e.children.length-2;t>=1;t--)e.children[t].dataset.keep||e.removeChild(e.children[t])}function countWords(e){const t=e.match(/\b\w+\b/g);return t?t.length:0}function estimateDuration(e,t=1){const n=countWords(e);n>2400&&(t*=.92),n>1e3&&(t*=.94),n>800&&(t*=.96),n<500&&(t*=.98),n<400&&(t*=.95),n<200&&(t*=.9),n<100&&(t*=.86);return n/(178*t)*60*1e3}function updateBar(){interval=setInterval((()=>{progress+=100;const e=Math.min(progress/estimatedDuration*100,100);progressBar.style.width=e+"%",progress>=estimatedDuration&&clearInterval(interval)}),100)}function startSpeech(){if(isPaused)return synth.resume(),updateBar(),document.getElementById("id-pauseSpeech").style.display="block",document.getElementById("id-startSpeech").style.display="none",document.getElementById("id-stopSpeech").style.display="block",playPause=!1,void(isPaused=!1);if(synth.speaking)return;document.getElementById("id-pauseSpeech").style.display="block",document.getElementById("id-startSpeech").style.display="none",document.getElementById("id-stopSpeech").style.display="block",playPause=!1,isPaused=!1;let e=Number(document.getElementById(activeVersionID).dataset.index),t=versions[e].lid,n=languages.findIndex((e=>e.lid===t));speechSynthesis.cancel(),setTimeout((()=>{utter=new SpeechSynthesisUtterance,utter.text=textSpeech,utter.lang=languages[n].lngc,utter.voice=voices.find((e=>e.lang===languages[n].lngc)),utter.rate=1,progress=0,estimatedDuration=estimateDuration(textSpeech.trim(),utter.rate),progressBar.style.width="0%",utter.onstart=()=>{updateBar()},utter.onend=()=>{progressBar.style.width="100%",stopSpeech(),document.getElementById("id-playCheckBox").checked&&(nextChapter(),setTimeout((()=>{startChapter()}),100))},synth.speak(utter)}),300)}function startChapter(){if(isPaused)return synth.resume(),updateBar(),document.getElementById("id-pauseSpeech").style.display="block",document.getElementById("id-startSpeech").style.display="none",document.getElementById("id-stopSpeech").style.display="block",playPause=!1,void(isPaused=!1);if(synth.speaking)return;document.getElementById("id-pauseSpeech").style.display="block",document.getElementById("id-startSpeech").style.display="none",document.getElementById("id-stopSpeech").style.display="block",playPause=!1,isPaused=!1;let e=document.getElementById(activeVersionID),t=Number(e.dataset.index),n=versions[t].lid,s=languages.findIndex((e=>e.lid===n));speechSynthesis.cancel(),setTimeout((()=>{utter=new SpeechSynthesisUtterance,utter.text=textSpeech.replace(`${versions[t].t}: `,""),utter.lang=languages[s].lngc,utter.voice=voices.find((e=>e.lang===languages[s].lngc)),utter.rate=1,progress=0,estimatedDuration=estimateDuration(textSpeech.trim(),utter.rate),progressBar.style.width="0%",utter.onstart=()=>{updateBar()},utter.onend=()=>{if(progressBar.style.width="100%",stopSpeech(),document.getElementById("id-playCheckBox").checked){nextChapter();let e=textSpeech;textSpeech="",textSpeech=e.replace("Twenty-First Century Version: ",""),setTimeout((()=>{startChapter()}),100)}},synth.speak(utter)}),300)}async function nextChapter(){return setTimeout((async()=>{let e=0,t=[],n=Number(document.getElementById(activeBookID).dataset.bid);n<40?(e=oldBooks.findIndex((e=>e.id===n)),t=oldBooks):(e=newBooks.findIndex((e=>e.id===n)),t=newBooks);let s=t[e].c,a=Number(document.getElementById(activeChapterID).textContent)+1;a>s&&(n++,a=1),activeBookID=`id-book${n}`,activeChapterID=`id-chapter${a}`,n<40?(e=oldBooks.findIndex((e=>e.id===n)),t=oldBooks):(e=newBooks.findIndex((e=>e.id===n)),t=newBooks),chapterCount=t[e].c,getChapter(),loadChapters(),document.getElementById("top").scrollIntoView({block:"start"})}),300),!0}function pauseSpeech(){synth.speaking&&(synth.pause(),isPaused=!0,clearInterval(interval),playPause?(document.getElementById("id-stopSpeech").style.display="none",document.getElementById("id-startSpeech").style.display="none",document.getElementById("id-pauseSpeech").style.display="block",playPause=!1):(document.getElementById("id-stopSpeech").style.display="none",document.getElementById("id-pauseSpeech").style.display="none",document.getElementById("id-startSpeech").style.display="block",playPause=!0))}function stopSpeech(){synth.paused&&synth.resume(),synth.cancel(),clearInterval(interval),document.getElementById("id-pauseSpeech").style.display="none",document.getElementById("id-stopSpeech").style.display="none",document.getElementById("id-startSpeech").style.display="block",utter=null,playPause=!0,isPaused=!1,progress=0,progressBar.style.width="0%"}async function getChapter(){let e=Number(activeBookID.slice("id-book".length)),t=Number(activeChapterID.slice("id-chapter".length)),n=verses.findIndex((n=>n.bid===e&&n.cn===t));removeElements("id-page");let s,a,i,o,d,r,l,c=document.createElement("h2"),u=document.getElementById("id-page");if(document.getElementById("id-SynthBtn2").textContent=document.getElementById(activeBookID).textContent,c.textContent=`${document.getElementById(activeBookID).textContent} ${t}`,document.getElementById("id-bottomTitleLine").textContent=c.textContent,isTWF){let e=document.createElement("span");e.classList.add("cs-edited"),e.textContent=` TWF - Last Edited: ${dateEdited}`,c.appendChild(e)}u.appendChild(c);let p=Number(document.getElementById(activeVersionID).dataset.index),h=verses.findIndex((t=>t.bid===e)),m=Number(verses[h].bid)-1;for(m<39?l=oldBooks[m].t:(m-=39,l=newBooks[m].t),textSpeech=`${versions[p].t}: ${l}: Chapter ${t}: `,verseCount=0;n<verses.length&&verses[n].cn===t&&verses[n].bid===e;){if(s=document.createElement("p"),s.id=`pid${verses[n].vid}`,a=verses[n].pn,textSpeech+=`Verse ${verses[n].vn}.... ${verses[n].vt} `,a>0&&paragraphLayoutDefault)for(;verses[n].pn===a;){i=document.createElement("span"),i.id=`id-versNumber${verses[n].vn}`,r=1===verses[n].vn?`${verses[n].vn} `:` ${verses[n].vn} `;let e=verses[n].vt;1===verses[n].jq?i.innerHTML=JesusQuote(e,r):(o=document.createElement("span"),o.classList.add("cs-verseNumber"),o.textContent=r,d=document.createTextNode(e),i.appendChild(o),i.appendChild(d)),s.appendChild(i),n++,verseCount++}else{i=document.createElement("span"),i.id=`id-versNumber${verses[n].vn}`,r=`${verses[n].vn} `;let e=verses[n].vt;1===verses[n].jq?i.innerHTML=JesusQuote(e,r):(o=document.createElement("span"),o.classList.add("cs-verseNumber"),o.textContent=r,d=document.createTextNode(e),i.appendChild(o),i.appendChild(d)),s.classList.add("cs-singleVerse"),s.appendChild(i),n++,verseCount++}u.appendChild(s)}return setFontSize(),document.getElementById("id-SynthBtn3").textContent=`${document.getElementById(activeChapterID).textContent}:`,!0}async function getDefaults(){const e=new URLSearchParams(window.location.search);let t=localStorage.getItem("redLetter");t&&(redLetterDefault=t);let n=e.get("verid");n&&(activeVersionID=`id-version${n}`),activeVersionID||(activeVersionID=defaultVersionID);let s=Number(activeVersionID.slice("id-version".length)),a=versions.findIndex((e=>e.id===s));activeLanguageID=versions[a].lid;let i=e.get("bid");i&&(activeBookID=`id-book${i}`),activeBookID||(activeBookID=defaultBookID);let o=e.get("cn");return o&&(activeChapterID=`id-chapter${o}`),activeChapterID||(activeChapterID=defaultChapterID),setTheme=localStorage.getItem("setTheme"),activeFontSize=localStorage.getItem("activeFontSize"),activeFontSize?activeFontSize=Number(activeFontSize):activeFontSize=1.06,activeFontSizeCount=localStorage.getItem("activeFontSizeCount"),activeFontSizeCount?activeFontSizeCount=Number(activeFontSizeCount):activeFontSizeCount=0,!0}async function getVersion(e=null){let t=null;e&&(t=e.target.id),t&&"id-resetDefaults"!==t||(t=activeVersionID);let n=document.getElementById(t),s=Number(n.dataset.index),a=`data/${versions[s].ar}/${versions[s].ar}Verses.json`;"TWF"===versions[s].ar?isTWF=!0:isTWF=!1;try{const e=await fetch(a);if(!e.ok)throw new Error(e.status);verses=await e.json(),activeVersionID=n.id,await getChapter(),document.getElementById("id-SynthBtn1").textContent=versions[s].ar,document.getElementById("id-headline").textContent=versions[s].t,activeVersionAbreviation=versions[s].ar,searchIndex=null}catch(e){let t=e.message;switch(e.message){case"500":t="Network fetch error: 500A!";break;case"503":t="No internet connection error: 503A!";break}alert(t)}return closeBoxes(),boxesAreOpen=!1,!0}window.addEventListener("load",(async()=>{let e=!1;e=await getDefaults(),e&&(e=!1,e=await loadLanguages()),e&&(e=!1,e=await loadVersions()),e&&(e=!1,e=await loadBooks()),e&&(e=!1,e=await loadChapters(),allLoaded=!0),e&&(e=!1,e=await getVersion()),e&&allLoaded&&(locateBox("id-header1","id-synth",-5),document.getElementById("id-synth").style.position="fixed",locateBox("id-synth","id-mainPage",-10),setTimeout((()=>{document.getElementById("id-loader").style.display="none",bookWidth()}),130)),e&&("1"===setTheme&&(darkTheme(),toggleTheme(),rotateTheme=!1),startUp()),window.addEventListener("resize",adjustPosition),"speechSynthesis"in window&&(progressBar=document.getElementById("id-progressBar"),synth=window.speechSynthesis,void 0!==speechSynthesis.onvoiceschanged?speechSynthesis.onvoiceschanged=listVoices:listVoices())})),window.onbeforeunload=e=>{synth&&(synth.cancel(),clearInterval(interval))};